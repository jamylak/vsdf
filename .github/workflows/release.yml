name: Release Binary Build

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release-binaries-04'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux Release
    # Use a 22.04 container for good glibc compatibility while having modern packages.
    # Binaries built here work on Ubuntu 22.04+ and most modern distros (Debian 12+, Fedora 36+, Arch, etc.)
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    timeout-minutes: 15

    steps:
    - name: Install Git
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        apt-get install -y --no-install-recommends git ca-certificates

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        apt-get install -y --no-install-recommends \
          build-essential cmake ninja-build \
          libspdlog-dev \
          libglfw3 libglfw3-dev libvulkan-dev \
          glslang-tools glslang-dev libglm-dev \
          pkg-config \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wno-error=array-bounds" -G Ninja .

    - name: Build
      run: cmake --build build

    - name: Install patchelf for fixing library paths
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y --no-install-recommends patchelf

    - name: Bundle dependencies and fix paths
      run: |
        mkdir -p release/linux/libs
        cp build/vsdf release/linux/
        chmod +x release/linux/vsdf
        
        echo "Bundling dynamic libraries..."
        
        # Find non-system libraries
        ldd build/vsdf | grep -E "(glslang|SPIRV|ffmpeg|libav)" | awk '{print $3}' | while read lib; do
          if [ -f "$lib" ]; then
            libname=$(basename "$lib")
            echo "Copying $libname"
            cp "$lib" release/linux/libs/
            
            # Also copy dependencies of this library
            ldd "$lib" 2>/dev/null | grep -E "(glslang|SPIRV|ffmpeg|libav)" | awk '{print $3}' | while read sublib; do
              if [ -f "$sublib" ]; then
                sublibname=$(basename "$sublib")
                if [ ! -f "release/linux/libs/$sublibname" ]; then
                  echo "  -> Copying dependency $sublibname"
                  cp "$sublib" release/linux/libs/
                fi
              fi
            done
          fi
        done
        
        echo "Fixing library paths..."
        
        # Set RPATH on main binary to look in libs/ folder
        patchelf --set-rpath '$ORIGIN/libs' release/linux/vsdf
        
        # Fix RPATH for each bundled library
        for lib in release/linux/libs/*.so*; do
          [ -f "$lib" ] && patchelf --set-rpath '$ORIGIN' "$lib" 2>/dev/null || true
        done
        
        echo "Bundle complete!"
        echo "Bundled libraries:"
        ls -lh release/linux/libs/
        
        echo "Binary RPATH:"
        patchelf --print-rpath release/linux/vsdf
        
        echo "Binary dependencies:"
        ldd release/linux/vsdf | head -20

    - name: Package binary
      run: |
        cp -r shaders release/linux/
        cp README.md release/linux/
        cp LICENSE release/linux/
        cd release
        tar -czf vsdf-linux-x86_64.tar.gz linux/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-linux-x86_64
        path: release/vsdf-linux-x86_64.tar.gz

  build-macos:
    name: Build macOS ${{ matrix.arch }} Release
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install glfw glslang spdlog glm vulkan-tools ffmpeg pkg-config

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DCMAKE_CXX_FLAGS="-Wno-error=sign-conversion -Wno-error=implicit-int-conversion" .

    - name: Build
      run: cmake --build build

    - name: Bundle dependencies and fix paths
      run: |
        # Create libs directory
        mkdir -p release/macos/libs
        
        # Copy the binary
        cp build/vsdf release/macos/
        
        # Find and copy all non-system dylibs
        echo "Bundling dynamic libraries..."
        
        # Get list of dynamic libraries (excluding system ones)
        DYLIBS=$(otool -L build/vsdf | grep -E "(glslang|spirv-tools|ffmpeg|libav)" | awk '{print $1}')
        
        for lib in $DYLIBS; do
          if [ -f "$lib" ]; then
            libname=$(basename "$lib")
            if [ -f "release/macos/libs/$libname" ]; then
              echo "Already copied $libname"
            else
              echo "Copying $libname"
              cp "$lib" release/macos/libs/
            fi

            # Also copy any dependencies of this library
            SUB_DYLIBS=$(otool -L "$lib" | grep -E "(glslang|spirv-tools|ffmpeg|libav)" | awk '{print $1}')
            for sublib in $SUB_DYLIBS; do
              if [ -f "$sublib" ]; then
                sublibname=$(basename "$sublib")
                if [ ! -f "release/macos/libs/$sublibname" ]; then
                  echo "Copying dependency $sublibname"
                  cp "$sublib" release/macos/libs/
                fi
              fi
            done
          fi
        done
        
        # Fix all library paths to use @rpath
        echo "Fixing library paths..."
        
        # Set rpath on the binary to look next to the executable
        install_name_tool -add_rpath "@executable_path" release/macos/vsdf
        
        # Fix paths in the main binary
        for lib in release/macos/libs/*.dylib; do
          libname=$(basename "$lib")
          # Find the original path in the binary
          ORIG_PATH=$(otool -L release/macos/vsdf | grep "$libname" | awk '{print $1}')
          if [ ! -z "$ORIG_PATH" ]; then
            echo "Fixing $libname in vsdf"
            install_name_tool -change "$ORIG_PATH" "@rpath/libs/$libname" release/macos/vsdf
          fi
        done
        
        # Fix inter-library dependencies
        for lib in release/macos/libs/*.dylib; do
          libname=$(basename "$lib")
          echo "Fixing paths in $libname"
          
          # Fix the library's own id
          install_name_tool -id "@rpath/libs/$libname" "$lib"
          
          # Fix references to other bundled libraries
          for otherlib in release/macos/libs/*.dylib; do
            othername=$(basename "$otherlib")
            ORIG_PATH=$(otool -L "$lib" | grep "$othername" | awk '{print $1}')
            if [ ! -z "$ORIG_PATH" ] && [ "$ORIG_PATH" != "@rpath/libs/$othername" ]; then
              install_name_tool -change "$ORIG_PATH" "@rpath/libs/$othername" "$lib"
            fi
          done
        done
        
        echo "Bundle complete!"
        echo "Bundled libraries:"
        ls -lh release/macos/libs/
        
        echo "Binary dependencies after fixing:"
        otool -L release/macos/vsdf

    - name: Code sign binaries
      run: |
        echo "Ad-hoc signing binary and libraries..."
        # Ad-hoc sign all libraries
        for lib in release/macos/libs/*.dylib; do
          echo "Signing $(basename "$lib")"
          codesign --force --sign - "$lib"
        done
        
        # Ad-hoc sign the main binary
        echo "Signing vsdf"
        codesign --force --sign - release/macos/vsdf
        
        echo "Verifying signatures..."
        codesign -v release/macos/vsdf
        for lib in release/macos/libs/*.dylib; do
          codesign -v "$lib"
        done

    - name: Package binary
      run: |
        cp -r shaders release/macos/
        cp README.md release/macos/
        cp LICENSE release/macos/
        cd release
        tar -czf vsdf-macos-${{ matrix.arch }}.tar.gz macos/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-macos-${{ matrix.arch }}
        path: release/vsdf-macos-${{ matrix.arch }}.tar.gz

  build-windows:
    name: Build Windows Release
    # Temporarily disabled - see https://github.com/jamylak/vsdf/issues/33
    if: false
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies via vcpkg
      timeout-minutes: 25
      run: |
        Write-Host "Installing dependencies via vcpkg..."
        vcpkg install vulkan:x64-windows glfw3:x64-windows glslang:x64-windows spdlog:x64-windows glm:x64-windows ffmpeg[avcodec,avformat,swscale]:x64-windows --recurse
        vcpkg integrate install
        Write-Host "Dependencies installed successfully"

    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      run: cmake --build build --config Release

    - name: Package binary
      run: |
        New-Item -ItemType Directory -Force -Path release\windows
        Copy-Item build\Release\vsdf.exe release\windows\
        Copy-Item -Recurse shaders release\windows\
        Copy-Item README.md release\windows\
        Copy-Item LICENSE release\windows\
        Compress-Archive -Path release\windows\* -DestinationPath release\vsdf-windows-x86_64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-windows-x86_64
        path: release/vsdf-windows-x86_64.zip

  create-release:
    name: Create GitHub Release
    # Note: build-windows temporarily excluded from needs due to issue #33
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/vsdf-linux-x86_64/vsdf-linux-x86_64.tar.gz
          artifacts/vsdf-macos-x86_64/vsdf-macos-x86_64.tar.gz
          artifacts/vsdf-macos-arm64/vsdf-macos-arm64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
