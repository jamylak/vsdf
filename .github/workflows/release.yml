name: Release Binary Build

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'copilot/add-cicd-workflow-for-builds'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build \
          libspdlog-dev \
          libglfw3 libglfw3-dev libvulkan-dev \
          glslang-tools glslang-dev libglm-dev \
          pkg-config \
          libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wno-error=array-bounds" -G Ninja .

    - name: Build
      run: cmake --build build

    - name: Package binary
      run: |
        mkdir -p release/linux
        cp build/vsdf release/linux/
        chmod +x release/linux/vsdf
        cp -r shaders release/linux/
        cp README.md release/linux/
        cp LICENSE release/linux/
        cd release
        tar -czf vsdf-linux-x86_64.tar.gz linux/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-linux-x86_64
        path: release/vsdf-linux-x86_64.tar.gz

  build-macos:
    name: Build macOS ${{ matrix.arch }} Release
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        brew install glfw glslang spdlog glm vulkan-tools ffmpeg pkg-config

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} .

    - name: Build
      run: cmake --build build

    - name: Package binary
      run: |
        mkdir -p release/macos
        cp build/vsdf release/macos/
        cp -r shaders release/macos/
        cp README.md release/macos/
        cp LICENSE release/macos/
        cd release
        tar -czf vsdf-macos-${{ matrix.arch }}.tar.gz macos/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-macos-${{ matrix.arch }}
        path: release/vsdf-macos-${{ matrix.arch }}.tar.gz

  build-windows:
    name: Build Windows Release
    # Temporarily disabled - see https://github.com/jamylak/vsdf/issues/33
    if: false
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies via vcpkg
      timeout-minutes: 25
      run: |
        Write-Host "Installing dependencies via vcpkg..."
        vcpkg install vulkan:x64-windows glfw3:x64-windows glslang:x64-windows spdlog:x64-windows glm:x64-windows ffmpeg[avcodec,avformat,swscale]:x64-windows --recurse
        vcpkg integrate install
        Write-Host "Dependencies installed successfully"

    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      run: cmake --build build --config Release

    - name: Package binary
      run: |
        New-Item -ItemType Directory -Force -Path release\windows
        Copy-Item build\Release\vsdf.exe release\windows\
        Copy-Item -Recurse shaders release\windows\
        Copy-Item README.md release\windows\
        Copy-Item LICENSE release\windows\
        Compress-Archive -Path release\windows\* -DestinationPath release\vsdf-windows-x86_64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsdf-windows-x86_64
        path: release/vsdf-windows-x86_64.zip

  create-release:
    name: Create GitHub Release
    # Note: build-windows temporarily excluded from needs due to issue #33
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/vsdf-linux-x86_64/vsdf-linux-x86_64.tar.gz
          artifacts/vsdf-macos-x86_64/vsdf-macos-x86_64.tar.gz
          artifacts/vsdf-macos-arm64/vsdf-macos-arm64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
