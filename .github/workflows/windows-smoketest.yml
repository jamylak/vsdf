name: Windows Smoke Test

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  windows-smoke-test:
    name: Windows Smoke Test (Software Rendering)
    runs-on: windows-latest
    
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies via vcpkg
      timeout-minutes: 15
      run: |
        Write-Host "Installing dependencies via vcpkg..."
        # vcpkg provides Vulkan headers/loader without needing full SDK installation
        vcpkg install vulkan:x64-windows --recurse
        vcpkg install glfw3:x64-windows
        vcpkg install glslang:x64-windows
        vcpkg install spdlog:x64-windows
        vcpkg install glm:x64-windows
        vcpkg integrate install
        Write-Host "All dependencies installed successfully"

    - name: Configure CMake
      timeout-minutes: 5
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTS=OFF `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      timeout-minutes: 10
      run: cmake --build build --config Release

    - name: Install Mesa3D lavapipe for software Vulkan rendering
      run: |
        Write-Host "Installing Mesa3D for software Vulkan support..."
        # Download and install Mesa3D which includes lavapipe Vulkan driver
        $url = "https://github.com/pal1000/mesa-dist-win/releases/download/24.2.7/mesa3d-24.2.7-release-msvc.7z"
        $output = "$env:TEMP\mesa3d.7z"
        Write-Host "Downloading Mesa3D..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Extracting Mesa3D..."
        7z x $output -o"$env:TEMP\mesa3d" -y
        
        # Copy ALL Mesa3D x64 DLLs to System32 (lavapipe has many dependencies)
        Write-Host "Installing Mesa3D binaries..."
        Get-ChildItem "$env:TEMP\mesa3d\x64\*.dll" | ForEach-Object {
          Copy-Item $_.FullName "$env:SystemRoot\System32\" -Force
          Write-Host "Copied $($_.Name)"
        }
        
        # Copy Vulkan ICD JSON
        Copy-Item "$env:TEMP\mesa3d\x64\lvp_icd.x86_64.json" "$env:SystemRoot\System32\" -Force
        
        # Set environment variable for Vulkan ICD
        Write-Host "Setting VK_ICD_FILENAMES environment variable..."
        echo "VK_ICD_FILENAMES=$env:SystemRoot\System32\lvp_icd.x86_64.json" >> $env:GITHUB_ENV
        Write-Host "Mesa3D installed successfully"

    - name: Check Vulkan capabilities
      run: |
        Write-Host "Checking for available Vulkan drivers..."
        Write-Host "VK_ICD_FILENAMES: $env:VK_ICD_FILENAMES"
        # List available GPUs and drivers (informational)
        Get-WmiObject Win32_VideoController | Select-Object Name, DriverVersion | Format-List

    - name: Single frame smoke test (headless)
      timeout-minutes: 2
      run: |
        Write-Host "Running single frame smoke test..."
        Write-Host "VK_ICD_FILENAMES is set to: $env:VK_ICD_FILENAMES"
        # Windows software rendering via Mesa3D lavapipe
        # Capture both stdout and stderr, check exit code explicitly
        try {
          & .\build\Release\vsdf.exe --toy shaders/testtoyshader.frag --frames 1 --headless --log-level debug 2>&1 | Tee-Object -Variable output
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Host "##[error]Application exited with code $exitCode"
            Write-Host "##[error]Single frame smoke test FAILED!"
            exit 1
          }
          Write-Host "##[section]✓ Single frame test passed (exit code: $exitCode)"
        } catch {
          Write-Host "##[error]Exception during single frame test: $_"
          exit 1
        }

    - name: 100 frame smoke test (headless)
      timeout-minutes: 5
      run: |
        Write-Host "Running 100 frame smoke test..."
        # Windows software rendering via Mesa3D lavapipe
        # Capture both stdout and stderr, check exit code explicitly
        try {
          & .\build\Release\vsdf.exe --toy shaders/testtoyshader.frag --frames 100 --headless --log-level info 2>&1 | Tee-Object -Variable output
          $exitCode = $LASTEXITCODE
          if ($exitCode -ne 0) {
            Write-Host "##[error]Application exited with code $exitCode"
            Write-Host "##[error]100 frame smoke test FAILED!"
            exit 1
          }
          Write-Host "##[section]✓ 100 frame test passed (exit code: $exitCode)"
        } catch {
          Write-Host "##[error]Exception during 100 frame test: $_"
          exit 1
        }
