name: Windows Smoke Test

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  windows-smoke-test:
    name: Windows Smoke Test (Software Rendering)
    runs-on: windows-latest
    
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies via vcpkg
      timeout-minutes: 15
      run: |
        Write-Host "Installing dependencies via vcpkg..."
        # vcpkg provides Vulkan headers/loader without needing full SDK installation
        vcpkg install vulkan:x64-windows --recurse
        vcpkg install glfw3:x64-windows
        vcpkg install glslang:x64-windows
        vcpkg install spdlog:x64-windows
        vcpkg install glm:x64-windows
        vcpkg integrate install
        Write-Host "All dependencies installed successfully"

    - name: Configure CMake
      timeout-minutes: 5
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTS=OFF `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      timeout-minutes: 10
      run: cmake --build build --config Release

    - name: Install Mesa3D WARP for software Vulkan rendering
      run: |
        Write-Host "Installing Mesa3D for software Vulkan support..."
        # Download and install Mesa3D which includes WARP/lavapipe Vulkan driver
        $url = "https://github.com/pal1000/mesa-dist-win/releases/download/24.2.7/mesa3d-24.2.7-release-msvc.7z"
        $output = "$env:TEMP\mesa3d.7z"
        Write-Host "Downloading Mesa3D..."
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Extracting Mesa3D..."
        7z x $output -o"$env:TEMP\mesa3d" -y
        # Copy Vulkan ICD and binaries to system paths
        Copy-Item "$env:TEMP\mesa3d\x64\lvp_icd.x86_64.json" "$env:SystemRoot\System32\" -Force
        Copy-Item "$env:TEMP\mesa3d\x64\vulkan_lvp.dll" "$env:SystemRoot\System32\" -Force
        # Set environment variable for Vulkan ICD
        Write-Host "Setting VK_ICD_FILENAMES environment variable..."
        echo "VK_ICD_FILENAMES=$env:SystemRoot\System32\lvp_icd.x86_64.json" >> $env:GITHUB_ENV
        Write-Host "Mesa3D installed successfully"

    - name: Check Vulkan capabilities
      run: |
        Write-Host "Checking for available Vulkan drivers..."
        Write-Host "VK_ICD_FILENAMES: $env:VK_ICD_FILENAMES"
        # List available GPUs and drivers (informational)
        Get-WmiObject Win32_VideoController | Select-Object Name, DriverVersion | Format-List

    - name: Single frame smoke test (headless)
      timeout-minutes: 2
      run: |
        Write-Host "Running single frame smoke test..."
        # Windows software rendering via WARP (included with Windows 10+)
        # WARP provides a software Vulkan implementation
        .\build\Release\vsdf.exe --toy shaders/testtoyshader.frag --frames 1 --headless --log-level debug
      continue-on-error: true
      id: single-frame

    - name: 100 frame smoke test (headless)
      timeout-minutes: 5
      run: |
        Write-Host "Running 100 frame smoke test..."
        .\build\Release\vsdf.exe --toy shaders/testtoyshader.frag --frames 100 --headless --log-level info
      continue-on-error: true
      id: hundred-frames

    - name: Verify smoke test results
      run: |
        $singleFrameSuccess = "${{ steps.single-frame.outcome }}" -eq "success"
        $hundredFramesSuccess = "${{ steps.hundred-frames.outcome }}" -eq "success"
        
        Write-Host "Single frame test: ${{ steps.single-frame.outcome }}"
        Write-Host "100 frame test: ${{ steps.hundred-frames.outcome }}"
        
        if (-not $singleFrameSuccess) {
          Write-Host "##[error]Single frame smoke test failed!"
          Write-Host "This is a critical failure - the application should be able to render at least one frame."
          exit 1
        } elseif (-not $hundredFramesSuccess) {
          Write-Host "##[warning]100 frame test failed but single frame succeeded."
          Write-Host "This may indicate performance issues or timeout problems."
          exit 1
        } else {
          Write-Host "âœ“ All smoke tests passed successfully!"
          exit 0
        }
