name: Windows CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main

jobs:
  build-and-test-windows:
    name: Build and Test on Windows
    runs-on: windows-latest
    
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies via vcpkg
      timeout-minutes: 15
      run: |
        Write-Host "Installing dependencies via vcpkg (faster and more reliable for CI)..."
        # vcpkg provides Vulkan headers/loader without needing full SDK installation
        vcpkg install vulkan:x64-windows --recurse
        vcpkg install glfw3:x64-windows
        vcpkg install glslang:x64-windows
        vcpkg install spdlog:x64-windows
        vcpkg install glm:x64-windows
        vcpkg install gtest:x64-windows
        vcpkg integrate install
        Write-Host "All dependencies installed successfully"

    - name: Configure CMake
      timeout-minutes: 5
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTS=ON `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      timeout-minutes: 10
      run: cmake --build build --config Release

    - name: Build and Install SwiftShader (Software Vulkan ICD)
      timeout-minutes: 20
      run: |
        Write-Host "Building SwiftShader from source..."
        
        # Clone SwiftShader repository
        git clone --depth 1 https://github.com/google/swiftshader.git swiftshader
        cd swiftshader
        
        # Create build directory and configure with CMake
        Write-Host "Configuring SwiftShader build..."
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DSWIFTSHADER_BUILD_TESTS=OFF `
          -DSWIFTSHADER_BUILD_SAMPLES=OFF `
          -DSWIFTSHADER_WARNINGS_AS_ERRORS=OFF `
          .
        
        # Build SwiftShader (only the Vulkan ICD)
        Write-Host "Building SwiftShader Vulkan ICD..."
        cmake --build build --config Release --target vk_swiftshader
        
        # Find the built vk_swiftshader.dll and ICD JSON
        $vkSwiftShaderDll = Get-ChildItem -Path "build" -Recurse -Filter "vk_swiftshader.dll" | Select-Object -First 1 -ExpandProperty FullName
        $icdJson = Get-ChildItem -Path "build" -Recurse -Filter "vk_swiftshader_icd.json" | Select-Object -First 1 -ExpandProperty FullName
        
        if ($vkSwiftShaderDll -and $icdJson) {
          Write-Host "SwiftShader DLL found at: $vkSwiftShaderDll"
          Write-Host "SwiftShader ICD JSON found at: $icdJson"
          
          # Update the ICD JSON to point to the correct DLL path
          $icdJsonContent = Get-Content $icdJson -Raw | ConvertFrom-Json
          $icdJsonContent.ICD.library_path = $vkSwiftShaderDll
          $icdJsonContent | ConvertTo-Json -Depth 10 | Set-Content $icdJson
          
          # Set environment variable for this workflow
          $icdJsonPath = Resolve-Path $icdJson
          echo "VK_ICD_FILENAMES=$icdJsonPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "VK_ICD_FILENAMES set to: $icdJsonPath"
        } else {
          Write-Error "SwiftShader build artifacts not found"
          exit 1
        }
        
        cd ..

    - name: Run unit tests
      timeout-minutes: 5
      run: |
        # Run vsdf_tests
        $vsdfTestPath = ".\build\tests\Release\vsdf_tests.exe"
        if (Test-Path $vsdfTestPath) {
          Write-Host "Running vsdf_tests..."
          & $vsdfTestPath
        } else {
          Write-Error "vsdf_tests not found at $vsdfTestPath"
          exit 1
        }
        # Run filewatcher_tests
        $filewatcherTestPath = ".\build\tests\filewatcher\Release\filewatcher_tests.exe"
        if (Test-Path $filewatcherTestPath) {
          Write-Host "Running filewatcher_tests..."
          & $filewatcherTestPath
        } else {
          Write-Error "filewatcher_tests not found at $filewatcherTestPath"
          exit 1
        }

    - name: Vulkan single frame smoke test
      timeout-minutes: 5
      run: |
        $vsdfPath = ".\build\Release\vsdf.exe"
        if (Test-Path $vsdfPath) {
          Write-Host "Running single frame smoke test..."
          & $vsdfPath --toy shaders/testtoyshader.frag --frames 1 --headless --log-level debug
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Single frame smoke test failed with exit code $LASTEXITCODE"
            exit 1
          }
          Write-Host "Single frame smoke test passed"
        } else {
          Write-Error "vsdf.exe not found at $vsdfPath"
          exit 1
        }

    - name: Vulkan 100 frame smoke test
      timeout-minutes: 5
      run: |
        $vsdfPath = ".\build\Release\vsdf.exe"
        if (Test-Path $vsdfPath) {
          Write-Host "Running 100 frame smoke test..."
          & $vsdfPath --toy shaders/testtoyshader.frag --frames 100 --headless --log-level info
          if ($LASTEXITCODE -ne 0) {
            Write-Error "100 frame smoke test failed with exit code $LASTEXITCODE"
            exit 1
          }
          Write-Host "100 frame smoke test passed"
        } else {
          Write-Error "vsdf.exe not found at $vsdfPath"
          exit 1
        }
