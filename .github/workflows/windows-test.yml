name: Windows CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main

jobs:
  build-and-test-windows:
    name: Build and Test on Windows
    runs-on: windows-latest
    
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Vulkan SDK
      run: |
        # Download and install Vulkan SDK
        # Note: Update this version periodically for latest SDK features and security updates
        $version = "1.3.296.0"
        $url = "https://sdk.lunarg.com/sdk/download/$version/windows/VulkanSDK-$version-Installer.exe"
        $installer = "$env:TEMP\vulkan-sdk.exe"
        Write-Host "Downloading Vulkan SDK version $version from $url"
        Invoke-WebRequest -Uri $url -OutFile $installer
        Write-Host "Installing Vulkan SDK..."
        Start-Process -FilePath $installer -ArgumentList "/S" -Wait
        # Wait for installation to complete
        Start-Sleep -Seconds 15

    - name: Setup VULKAN_SDK environment
      run: |
        # Find the installed Vulkan SDK directory
        if (Test-Path "C:\VulkanSDK") {
          $vulkanPath = Get-ChildItem -Path "C:\VulkanSDK" -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($vulkanPath) {
            Write-Host "Found Vulkan SDK at: $($vulkanPath.FullName)"
            echo "VULKAN_SDK=$($vulkanPath.FullName)" >> $env:GITHUB_ENV
            echo "VK_SDK_PATH=$($vulkanPath.FullName)" >> $env:GITHUB_ENV
            echo "$($vulkanPath.FullName)\Bin" >> $env:GITHUB_PATH
          } else {
            Write-Error "Vulkan SDK directory exists but is empty"
            exit 1
          }
        } else {
          Write-Error "Vulkan SDK not found in C:\VulkanSDK"
          exit 1
        }

    - name: Install vcpkg dependencies
      run: |
        vcpkg install glfw3:x64-windows
        vcpkg install glslang:x64-windows
        vcpkg install spdlog:x64-windows
        vcpkg install glm:x64-windows
        vcpkg install gtest:x64-windows
        vcpkg integrate install

    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_TESTS=ON `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          .

    - name: Build
      run: cmake --build build --config Release

    - name: Run unit tests
      run: |
        # Run vsdf_tests
        $vsdfTestPath = ".\build\tests\Release\vsdf_tests.exe"
        if (Test-Path $vsdfTestPath) {
          Write-Host "Running vsdf_tests..."
          & $vsdfTestPath
        } else {
          Write-Error "vsdf_tests not found at $vsdfTestPath"
          exit 1
        }
        # Run filewatcher_tests
        $filewatcherTestPath = ".\build\tests\filewatcher\Release\filewatcher_tests.exe"
        if (Test-Path $filewatcherTestPath) {
          Write-Host "Running filewatcher_tests..."
          & $filewatcherTestPath
        } else {
          Write-Error "filewatcher_tests not found at $filewatcherTestPath"
          exit 1
        }
